<!DOCTYPE html>
<html>
<body>
<title>Spiroflow</title>
<h1>Spiroflow</h1>

<p>Spiroflow is an excellent product!!!</p>
<p>
<button onclick="begin_sens()" id='beginsens'>Start sensors</button>
</p>
Temperature: <input type='text' id='show_temp' width=10px/>
Humidity: <input type='text' id='show_hum' width=10px/>
Lung volume: <input type='text' id='show_vol' width=10px/>

<canvas id="flowspeedchart" style="position:relative;width:100px;height:25px"></canvas>
<button onclick="resetflow()" id='resetflow'>Reset</button>
<canvas id="totalvolchart" style="position:relative;width:100px;height:25px"></canvas>


<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<script src="node_modules/chart.js/dist/Chart.js"></script>
<script type="text/javascript" language="javascript">
var host = "test.mosquitto.org";
var port = 8080;
var topic = "IC.embedded/benchpsu"

// Create a client instance
client = new Paho.MQTT.Client(host, port, "clientjs");

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect});


// called when the client connects
function onConnect() {
	// Once a connection has been made, make a subscription and send a message.
	console.log("onConnect");
	client.subscribe(topic);
	message = new Paho.MQTT.Message("Hello");
	message.destinationName = topic;
	client.send(message);
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
	if (responseObject.errorCode !== 0) {
		console.log("onConnectionLost:"+responseObject.errorMessage);
	}
}

// called when a message arrives
function onMessageArrived(message) {
	messtr = message.payloadString;
	meswords = messtr.split(" ");	

	if(messtr.charAt(0) === 'f' && meswords.length === 3){
		flowdata = meswords[0].substr(1,);
		flowdata = parseFloat(flowdata);
		flow_speed(flowdata);

		tempdata = meswords[1].substr(1,);
		tempdata = parseFloat(tempdata);
		show_temp(tempdata);

		humdata = meswords[2].substr(1,);
		humdata = parseFloat(humdata);
		show_hum(humdata);
	}

}

//add data to chart
function addData(chart, data){
	chart.data.datasets.forEach((dataset) =>{
		dataset.data.shift();
		dataset.data.push(data);
	});
	chart.update();
}

//reset chart to all 0s
function resetflow(){
	for(i=0; i < 51; i++){
		addData(speedchart, 0);
		addData(volchart, 0);
	}
	volume = 0;
}

function begin_sens(){
	topic = "IC.embedded/benchpsu";
	message = new Paho.MQTT.Message("start");
	message.destinationName = topic;
	client.send(message);
}

flowvals = []; volvals = []; labels_flow = [];
for(i = 0; i < 51; i++){
	flowvals.push(0);
	volvals.push(0);
	labels_flow.push(i*0.1);
}

var ctx = document.getElementById("flowspeedchart");
var ctx2 = document.getElementById("totalvolchart");

var speedchart = new Chart(ctx, {
	responsive: true,
	type: 'line',
	data: {
		labels: labels_flow,
		datasets: [{
			cubicInterpolationMode: 'monotone',
			data: flowvals,
			borderColor: ['rgba(0, 0, 255, 1)']
		}]
	},
	options: {
		responsive: true,
        scales: {
        	xAxes: [{
        		display: true,
        		scaleLabel:{
        			display: true,
        			labelString: "Time (s)"
        		},
        		ticks:{
        			precision: 1,
        			stepSize: 0.5,
        			maxTicksLimit: 50
        		}
        	}],
            yAxes: [{
            	display: true,
            	type: 'linear',
            	scaleLabel:{
        			display: true,
        			labelString: "Air speed (m/s)"
        		},
            	ticks:{
            		min: -1.0,
            		max: 3.0
        		}
            }]
        },
        legend:{
        	display: false
        },
        title:{
        	display: true,
        	text: 'Air flow speed'
        }
    }
})
var volchart = new Chart(ctx2, {
	responsive: true,
	type: 'line',
	data: {
		labels: labels_flow,
		datasets: [{
			cubicInterpolationMode: 'monotone',
			data: volvals,
			borderColor: ['rgba(0, 0, 255, 1)']
		}]
	},
	options: {
		responsive: true,
        scales: {
        	xAxes: [{
        		display: true,
        		scaleLabel:{
        			display: true,
        			labelString: "Time (s)"
        		},
        		ticks:{
        			precision: 1,
        			stepSize: 0.5,
        			maxTicksLimit: 50
        		}
        	}],
            yAxes: [{
            	display: true,
            	type: 'linear',
            	scaleLabel:{
        			display: true,
        			labelString: "Volume (l)"
        		},
            	ticks:{beginAtZero: true}
            }]
        },
        legend:{
        	display: false
        },
        title:{
        	display: true,
        	text: 'Lung volume'
        }
    }
})


volume = 0;
volvec = [];
maxvol = 0;
cnt_neg = 0;
function flow_speed(data){
	flowvals_all = [];
	console.log('logged');
	addData(speedchart, data);
	if(data > 0 && cnt_neg < 3){
		volume = volume + data * 0.125;
		addData(volchart, volume);
	} else if (data < 0 && cnt_neg < 3){
		cnt_neg ++;
		volume = volume + data * 0.2;
		addData(volchart, volume);
	} else if (cnt_neg >= 3){
		cnt_neg = 0;
		if(maxvol < volume){
			maxvol = volume;
			volvec.push(volume);
			volume = 0;
			addData(volchart, volume);

			var voldisplay = document.getElementById('show_vol');
			voldisplay.value = maxvol.toString() + 'l';
		}
	}
}

function show_temp(data){
	var tempdisplay = document.getElementById('show_temp');
	console.log(tempdisplay);
	tempdisplay.value = data.toString() + "C";
}

function show_hum(data){
	var humdisplay = document.getElementById('show_hum');
	humdisplay.value = data.toString() + "%";
}

function init_displays(){
	var tempdisplay = document.getElementById('show_temp');
	var humdisplay = document.getElementById('show_hum');
	var voldisplay = document.getElementById('show_vol')

	tempdisplay.value = "Start temperature sensor"
	humdisplay.value = "Start humidity sensor"
	voldisplay.value = "Start flow sensor"
}

//init_displays();
</script>

</body>
</html>